name: Test Conda Recipe

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to smoke-test from PyPI (defaults to pyproject.toml version)"
        required: false
        type: string
  release:
    types: [published]

permissions:
  contents: read

jobs:
  conda-build:
    if: github.event_name != 'release' || vars.ENABLE_PYPI_PUBLISH == 'true'
    name: ${{ matrix.os }} / py${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    defaults:
      run:
        shell: bash -el {0}

    env:
      CONDA_BLD_PATH: ${{ github.workspace }}/conda-bld

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve version and sync recipe from PyPI
        id: pypi
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "release" ]]; then
            tag="${{ github.event.release.tag_name }}"
            version="${tag#v}"
          elif [[ -n "${{ inputs.version || '' }}" ]]; then
            version="${{ inputs.version }}"
            tag="v${version}"
          else
            version="$(grep -m1 '^version = "' pyproject.toml | sed -E 's/version = "([^"]+)"/\1/')"
            tag="v${version}"
          fi

          pyproject_version="$(grep -m1 '^version = "' pyproject.toml | sed -E 's/version = "([^"]+)"/\1/')"
          if [[ "$version" != "$pyproject_version" ]]; then
            echo "Version mismatch: tag/dispatch version '$version' vs pyproject.toml '$pyproject_version'" >&2
            exit 1
          fi

          echo "Target version: $version"

          for attempt in $(seq 1 10); do
            if python .github/scripts/conda_recipe_sync_from_pypi.py "$version" \
              --package vbmicrolensing \
              --recipe conda/meta.yaml \
              --drop-stdlib-c
            then
              break
            fi

            if [[ "$attempt" -eq 10 ]]; then
              echo "PyPI sdist metadata not available for vbmicrolensing==$version after retries" >&2
              exit 1
            fi

            echo "PyPI metadata not ready yet (attempt $attempt/10), retrying in 30s..." >&2
            sleep 30
          done > /tmp/pypi_sdist_info.txt

          source_url="$(sed -n '1p' /tmp/pypi_sdist_info.txt)"
          source_sha256="$(sed -n '2p' /tmp/pypi_sdist_info.txt)"

          echo "PyPI sdist URL: $source_url"
          echo "PyPI sdist SHA256: $source_sha256"

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "sha256=$source_sha256" >> "$GITHUB_OUTPUT"

      - name: Set up Miniforge
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-variant: Miniforge3
          miniforge-version: latest
          auto-update-conda: false
          activate-environment: base
          python-version: ${{ matrix.python-version }}
          channels: conda-forge
          channel-priority: strict
          use-mamba: true

      - name: Install conda-build tooling
        run: |
          conda info
          mamba install -n base -c conda-forge "conda<25" "conda-build<25" "conda-index>=0.7"
          conda list | grep -E '^(conda|conda-build|conda-index|libmamba|conda-libmamba-solver)\s' || true

      - name: Render recipe
        run: |
          conda render conda \
            --override-channels -c conda-forge \
            --python "${{ matrix.python-version }}"

      - name: Build and test recipe
        run: |
          conda build conda \
            --override-channels -c conda-forge \
            --python "${{ matrix.python-version }}" \
            --no-anaconda-upload

      - name: Upload built packages
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conda-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ${{ github.workspace }}/conda-bld/**/*.conda
          if-no-files-found: ignore
